# プロキシの魔術師のコーディングガイド（閉域網環境でのAI開発・サバイバル戦略）
## description: 閉域・プロキシ・SSLインスペクション環境でも、安全にAIと開発を回すための実務ガイド（全15ページ解説）

## 1. プロキシの魔術師のコーディングガイド（表紙）

![Pr1.プロキシの魔術師のコーディングガイド](/images/network/Pr1.プロキシの魔術師のコーディングガイド.jpg)

### 図の要旨

* 閉域網・厳格セキュリティ環境での開発は「詰まりどころ」が独特で、**設定（通し方）を知るだけで生存率が跳ね上がる**。
* 目的は“突破”ではなく、**ガバナンスに従いながら最短で成果を出す**こと。

### 詳細解説（用語）

* **閉域網（クローズドネットワーク）**：インターネットに直接出られない／出るにはプロキシ経由が必須の環境。
* **プロキシ（Proxy）**：社内端末→外部サービスの間に入る中継装置。認証・監査・フィルタの役割を持つ。
* **ガバナンス（Governance）**：利用ルール・責任分界・監査・承認手順。AIはここが無いと“止まる”。

### Tips（実務）

* 最初に覚えるべき合言葉：**「環境は変えられない。変えるのは“通し方”」**
  以降は “通し方” を体系化します。

---

## 2. なぜ閉域網の開発は「重い」のか？

![Pr2.なぜ、閉域網での開発はこれほど「重い」のか？](/images/network/Pr2.なぜ、閉域網での開発はこれほど「重い」のか？.jpg)

### 図の要旨

* `docker pull` / `pip install` / `npm install` のような**外部取得**が、プロキシ/ファイアウォールで詰まりやすい。
* その代償として、**高いセキュリティ**（機密・金融データ保護）を得ている、というトレードオフ。

### 詳細解説（用語）

* **タイムアウト**：外へ出られず待ち続けて失敗する状態。プロキシ未設定が典型。
* **認証エラー**：プロキシは認証必須のことが多い（ID/パスワード、端末証明、SSOなど）。
* **ファイアウォール**：通信の出口を制御。許可されない宛先/プロトコルは遮断される。

### Tips（実務）

* 「重い」を分解すると、だいたいこの3択です：

  1. **プロキシ未設定**（出口がない）
  2. **SSL証明書問題**（MITM/インスペクション）
  3. **ツール別設定の食い違い**（OS環境変数だけでは足りない）
* 解決は“全てを一度に直す”ではなく、**1箇所ずつ通る経路を増やす**のが安全です。

---

## 3. 真の敵：SSLインスペクション（MITM）の正体

![Pr3.真の敵：SSLインスペクション（MITM）の正体](/images/network/Pr3.真の敵：SSLインスペクション（MITM）の正体.jpg)

### 図の要旨

* 社内プロキシが **TLS通信を一度復号→検査→再暗号化**する（＝SSLインスペクション）。
* ツール側はそれを「攻撃者の中間者（MITM）」と誤解し、`SELF_SIGNED_CERT_IN_CHAIN` や `SSLCertVerificationError` を出す。

### 詳細解説（用語）

* **TLS/SSL**：暗号化通信の仕組み（https）。
* **SSLインスペクション**：暗号化をほどいて中身検査する運用。DLP（情報漏洩対策）やマルウェア対策で導入される。
* **社内ルート証明書（Corporate Root CA）**：社内プロキシが再暗号化に使う“社内の正規証明書”。これを端末・ツールに信頼させる必要がある。

### Tips（実務）

* 重要ポイント：**「壊れている」のではなく「守られている」**
  対応は“無効化”ではなく、**社内ルート証明書を正しく信頼させる**です。
* まずはインフラ担当に確認したいこと：

  * ルート証明書（`.crt` / `.pem`）の配布手順
  * 証明書の更新周期（いつ切り替わるか）

---

## 4. 第1の魔法：3つの聖なる環境変数（HTTP(S)_PROXY / NO_PROXY）

![Pr4.第一の魔法：３つの聖なる環境変数](/images/network/Pr4.第一の魔法：３つの聖なる環境変数.jpg)

### 図の要旨

* 外部への出口は `HTTP_PROXY` / `HTTPS_PROXY`。（これらを設定しなければツールはプロキシを経由せず、迷子になります、**閉域網では設定必須**）
* **最重要**は `NO_PROXY`：プロキシ除外設定であり、ここに入れないと、わざわざプロキシーを見に行きそこではじかれる、その結果 **社内サーバへすら繋がらない**ことがある。

### 詳細解説（用語）

* **HTTP_PROXY / HTTPS_PROXY**：外部通信をプロキシ経由にする設定（OS環境変数）。
* **NO_PROXY**：プロキシを経由しない宛先リスト。
  `localhost` や社内ドメイン、社内Git、社内Artifactory/Nexus 等を入れることが多い。

### Tips（実務）

* まずは最小セットから始める（例）：

```bash
# 1) 外部への出口
export HTTP_PROXY="http://USER:PASS@proxy.example.co.jp:8080"
export HTTPS_PROXY="http://USER:PASS@proxy.example.co.jp:8080"

# 2) 内部は直通（ここがないと社内も巻き込まれる）
export NO_PROXY="localhost,127.0.0.1,.example.co.jp"
```

* **NO_PROXYの設計ミス**で起きる症状（ありがち）：

  * 社内Gitが「急に遅い/落ちる」
  * Dockerビルドだけ失敗する（後述の“コンテナ内外”差）
* チームで共有するなら、`.envrc`（direnv）やシェル関数化で“事故”が減ります。

---

## 5. 第2の魔法：ツールごとの「方言」を知る（git / npm / VSCode / docker）

![Pr5.第二の魔法：ツールごとの「方言」を知る](/images/network/Pr5.第二の魔法：ツールごとの「方言」を知る.jpg)

### 図の要旨

* プロキシは「OS環境変数だけでOK」とは限らない。
* **git / npm / VSCode / docker** は、それぞれ設定場所や優先順位が違う。

### 詳細解説（用語）

* **グローバル設定**：ツールが持つ“自前の設定”（例：git config）。
* **アプリケーション設定**：VSCodeのSettingsなど、GUI側に別設定がある。
* **ビルド時と実行時**：Dockerは特にここが別（ビルドはホスト設定、実行はコンテナ内設定）。

### Tips（実務）

* よく詰まる順に“確認コマンド”を用意すると速いです。

**git（例：HTTPプロキシを明示）**

```bash
git config --global http.proxy  http://USER:PASS@proxy.example.co.jp:8080
git config --global https.proxy http://USER:PASS@proxy.example.co.jp:8080
git config --global --get http.proxy
```

**npm（例：npmの設定に入れる）**

```bash
npm config set proxy http://USER:PASS@proxy.example.co.jp:8080
npm config set https-proxy http://USER:PASS@proxy.example.co.jp:8080
npm config get proxy
```

**Docker（ビルド時に渡す例）**

```bash
docker build \
  --build-arg HTTP_PROXY="$HTTP_PROXY" \
  --build-arg HTTPS_PROXY="$HTTPS_PROXY" \
  .
```

* 実務の鉄則：**「ビルドが通るのに実行が落ちる」＝コンテナ内の設定不足**を疑う。

---

## 6. 第3の魔法：証明書とパスワードの罠（CERT / URLエンコード）

![Pr6.第三の魔法：証明書とパスワードの罠](/images/network/Pr6.第三の魔法：証明書とパスワードの罠.jpg)

### 図の要旨

* **証明書の罠**：社内ルート証明書をツールに認識させないと `SELF_SIGNED_CERT_IN_CHAIN`。
* **パスワードの罠**：`@` や `:` などが混ざると、URLとして壊れる（→URLエンコードが必要）。

### 詳細解説（用語）

* **.crt / .pem**：証明書ファイル形式。ツールによって要求が違う。
* **URLエンコード（パーセントエンコード）**：特殊文字を `%xx` に置き換える。
  例：`@` → `%40`

### Tips（実務）

* 対応の基本方針はこれです：

  1. **インフラ担当から社内ルート証明書を必ず入手**
  2. ツールに“信頼する証明書”として登録
  3. プロキシURLに認証情報を埋める場合は、**パスワードをURLエンコード**

**pip（例：証明書を指定）**

```bash
pip config set global.cert "/path/to/corporate-root.crt"
```

**URLエンコードの例**

* `P@ssword` → `P%40ssword`

> 注意：認証情報をURLに直書きせず、可能なら **認証はOS/SSO側** に寄せた方が運用安全です（ログや履歴に残りにくい）。

---

## 7. 禁じられた手：なぜ「Claude Code」系がNGになりがちか？

![Pr7.禁じられた手：なぜ「ClaudeCode」はNGなのか？](/images/network/Pr7.禁じられた手：なぜ「ClaudeCode」はNGなのか？.jpg)

### 図の要旨

* NG理由は大きく3つ：

  1. **情報漏洩リスク**（ログ/実行結果が外部送信され得る）
  2. **技術的障壁**（WebSocketなどが閉域で塞がれる）
  3. **ガバナンス**（シャドーIT扱い）

### 詳細解説（用語）

* **シャドーIT**：組織が許可していないIT利用。監査・事故対応ができず、最終的に“全部止まる”原因になる。
* **WebSocket**：双方向通信。閉域では許可されないことが多い。

### Tips（実務）

* 結論：**無理に通すほど、後で止まる**（監査・利用停止・再構築でコスト増）。
  “使える武器”を最初から選ぶのが最短です（次ページ）。

---

## 8. 王国の武器庫：3つの許可されたAI（tsuzumi / Azure OpenAI / GitHub Copilot）

![Pr8.王国の武器庫：３つの認可されたAI](/images/network/Pr8.王国の武器庫：３つの認可されたAI.jpg)

### 図の要旨

* 高セキュリティ契約・統制の枠内で使える「正規ルート」の代表例として3つを提示。
* 重要なのは、**1つで全部やらず、役割分担（適材適所）**にすること。

### 詳細解説（用語）

* **Specialist（特化）**：日本語・業界文書など、狙いを絞った強み。
* **Generalist（汎用）**：幅広いタスクに対応。
* **Partner/Builder（開発支援）**：コード・テスト・レビューなど開発工程を加速。

### Tips（実務）

* “導入”で詰まるのは大抵ここ：

  * 認証（SSO）
  * 利用申請（ライセンス割当）
  * ルート証明書（閉域/SSLインスペクション）
    なので、技術より先に **申請・権限・証明書** を揃えると勝ちやすいです。

---

## 9. 武器1：tsuzumi（日本語特化の業務コンサルタント）

![Pr9.武器１：tsuzumi（NTT版大規模言語モデル）](/images/network/Pr9.武器１：tsuzumi（NTT版大規模言語モデル）.jpg)

### 図の要旨

* 日本語特化・業務文書向けの“相談役”として位置づけ。
* 軽量（少ないGPUで運用可能）・オンプレ/プライベート運用の選択肢が出やすい。

### 詳細解説（用語）

* **軽量モデル**：必要十分な推論を、少ない計算資源で回す思想。コストと運用性に効く。
* **RFP**：提案依頼書。文章量が多く、論点抽出・要約が効く代表例。

### Tips（実務）

* tsuzumi系（日本語強め）に寄せると安定しやすいタスク例：

  * 仕様書・議事録・稟議の**要点抽出**
  * “曖昧な日本語”の**論点整理**（前提、決定事項、未決事項）
* 実務プロンプトの型（例）：

  * 「この文書から **決定事項/未決事項/要確認の前提** をそれぞれ箇条書きで出して」

---

## 10. 武器2：Azure OpenAI Service（閉域で使う万能アシスタント）

![Pr10.武器2：AzureOpenAIService（SecureEnvironment）](/images/network/Pr10.武器2：AzureOpenAIService（SecureEnvironment）.jpg)

### 図の要旨

* “入力データの学習利用なし”など、企業利用の前提が整った形で使える。
* 閉域接続で、インターネットを経由せず社内から直接アクセスできる構成を示す。

### 詳細解説（用語）

* **No Training on Input**：入力がモデル学習に使われない（運用/契約条件として明確化されることが多い）。
* **閉域接続**：VPN/専用線/プライベート経路等。監査・統制に有利。

### Tips（実務）

* 汎用LLMが刺さりやすい“現場”の例：

  * **アーキテクチャの壁打ち**（案を複数出させ、比較表にする）
  * **テストデータ生成**（境界値、異常系、パターン網羅）
  * **英語ドキュメントの読解**（要約→重要箇所の翻訳→適用手順）
* ただし“汎用”ほど事故も起きやすいので、**根拠の出せない断定は禁止**（「根拠が無ければ不明と言う」）をプロンプトに入れると安定します。

---

## 11. 武器3：GitHub Copilot Enterprise（究極のペアプログラマー）

![Pr11.武器3：GitHubCopilotEnterprise](/images/network/Pr11.武器3：GitHubCopilotEnterprise.jpg)

### 図の要旨

* `@workspace` のように、リポジトリ全体を見た上で説明・提案できる。
* レガシーコードの理解、ボイラープレート生成、規約に沿ったリファクタが主戦場。

### 詳細解説（用語）

* **レガシーコード**：仕様が暗黙で、変更が怖いコード。AIは「読み解き」と「影響範囲の候補出し」で効く。
* **ボイラープレート**：定型コード（DTO、バリデーション、例外処理、テスト雛形など）。

### Tips（実務）

* Copilotを“安全に強く”使うコツ：

  * 先に **コーディング規約（ログ、例外、命名、テスト方針）** を貼る
  * 「この規約に違反しない形で、最小変更で修正案を出して」と指示する
* レビュー効率化の型（例）：

  * 「この差分の **目的/副作用/影響範囲/テスト観点** を列挙して」

---

## 12. 魔術師のワークフロー：ツールの使い分け（要件→設計→実装）

![Pr12.魔術師のワークフロー：ツールの使い分け](/images/network/Pr12.魔術師のワークフロー：ツールの使い分け.jpg)

### 図の要旨

* Phase1（要件）：tsuzumi（日本語仕様の要点抽出）
* Phase2（設計）：Azure OpenAI（設計のアイデア出し、比較）
* Phase3（実装）：GitHub Copilot（コード補完、レガシー解読）
* **「1つのツールで全部やろうとしない」**が結論。

### 詳細解説（用語）

* **要件定義**：何を作るか。曖昧さを減らす工程。
* **設計**：どう作るか。選択肢の比較が中心。
* **実装**：手を動かす工程。規約順守と変更影響が中心。

### Tips（実務）

* 使い分けの“判断基準”を1行で言うと：

  * **文章の曖昧さを潰す** → 要件（特化/日本語）
  * **選択肢を広げて比較** → 設計（汎用）
  * **規約に沿って形にする** → 実装（Copilot）
* この分業にすると、ガバナンス面でも説明しやすい（用途が明確）。

---

## 13. コミュニケーションの魔法：Teams vs Slack（使い分け）

![Pr13.コミュニケーションの魔法：TeamsとSlack](/images/network/Pr13.コミュニケーションの魔法：TeamsとSlack.jpg)

### 図の要旨

* Teams：**表玄関（Formal）**（承認、会議、仕様共有）
* Slack：**作業場（Real-time）**（開発雑談、エラー共有）
* 警告：インターネット側のSlack等に **閉域コード/機密を貼らない**。

### 詳細解説（用語）

* **Formal**：監査に残すべき情報（決裁、合意事項）。
* **Real-time**：スピード優先の現場会話（ただし機密は出さない）。

### Tips（実務）

* 事故を防ぐ運用ルール例：

  * Slack等には **「ログの抜粋（個人情報/鍵/URL/社内名をマスク）」**のみ貼る
  * コード全文は **社内Gitのリンク**で共有（権限・監査が効く）
* “貼ってよいテンプレ”を決めると事故が減ります（例：エラー要約＋再現手順＋環境情報＋マスク済みログ）。

---

## 14. Day1アクションプラン：管理者への「魔法の質問」（最短で環境を揃える）

![Pr14.Day1アクションプラン：管理者への「魔法の質問」](/images/network/Pr14.Day1アクションプラン：管理者への「魔法の質問」.jpg)

### 図の要旨

* 初日に揃えるべきはこの3点：

  1. Copilotライセンス
  2. ポータルURL（tsuzumi / Azure OpenAI等の入口）
  3. ルート証明書（.crt）

### 詳細解説（用語）

* **ライセンス割当**：申請しただけでは付かないことがある。管理者が割り当てて初めて使えるケースが多い。
* **ポータルURL**：閉域では“入口がどれか”が分からず迷子になりやすい。最初に正規URLを確定する。

### Tips（実務）

* 管理者に投げる質問テンプレ（そのまま使える形）：

  * 「開発効率化のため、**Copilot Enterpriseのライセンス割当**をお願いできますか？」
  * 「閉域で利用できる **LLMポータル（社内URL）** はどれですか？（利用申請先も含めて）」
  * 「プロキシ通過に必要な **社内ルート証明書（.crt/.pem）** の入手手順を教えてください」
* これを揃えるだけで、ハマり時間が大きく減ります。

---

## 15. 見習いから、魔術師へ（まとめ：今すぐNO_PROXYを設定しよう）

![Pr15.見習いから魔術師へ](/images/network/Pr15.見習いから魔術師へ.jpg)

### 図の要旨

* 成長の3ステップ：

  1. **プロキシ設定を制し、壁を越える**
  2. **シャドーITを避け、ガバナンスを守る**
  3. **3つの正規ツール（特化/汎用/開発）を使いこなす**
* 結論は実務的：**「今すぐNO_PROXYを設定しよう」**

### 詳細解説（用語）

* **守る＝遅い**ではない。
  統制されたルートがあると、事故対応・監査・再現性が上がり、結果的に速くなる。
* **“通し方”の標準化**：個人の職人芸ではなく、チームで再利用できる形（ドキュメント/テンプレ/スクリプト）にするのが最終到達点。

### Tips（実務）

* チームで共有する“最小セット”はこれだけで十分強いです：

  * `HTTP(S)_PROXY` と `NO_PROXY` の標準値
  * 社内ルート証明書の入手手順
  * ツール別（git/npm/docker）の設定メモ
* 最後にチェック：**「社内はNO_PROXYで直通、外部はHTTP(S)_PROXYで出口へ」**
  ここが崩れると、何をやっても不安定になります。

