# 閉域網の達人になる：コマンドライン・サバイバルキット
## description: GUIを捀て、ターミナルで「繋がらない」を切り分ける。curl / tnc / netsh / openssl / whoami で閉域網を生き残る実務ガイド（1ファイル統合版）
---

# 閉域網の達人になる：コマンドライン・サバイバルキット
GUIを捀てよ、黒い画面（ターミナル）を開こう。  
プロフェッショナルが選ぶ「生存」のための技術。

---

## この資料の目的
閉域網（強制プロキシ、SSLインスペクション、権限制御が強い環境）で発生する **「繋がらない／遅い／権限がない」** を、コマンドラインで **原因の階層（レイヤ）ごとに切り分け**、最短で復旧へ導くこと。

---

## 最短で迷わない切り分け手順（まずはこれだけ）
1. **TCPが生きているか**：`Test-NetConnection`（tnc）で 443/80 が通るか確認  
2. **HTTP(S)が成立するか**：`curl -I` → `curl -L` → `curl -v` の順で確認  
3. **プロキシが原因か**：`curl -x` / `-U`、環境変数、WinHTTP（netsh）を確認  
4. **証明書が原因か**：`openssl s_client` で「Issuer（発行者）」を見て根本原因を確定  
5. **権限・端末状態か**：`whoami` / `systeminfo` / `wmic qfe` で「政治（権限）」と「技術（状態）」を分離  

---

# 1. 表紙：閉域網の達人になる
![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)


### 図の要旨
- 閉域網は「ネットが遅い」ではなく、**出口・検問・通行手形**がある世界。
- GUIの表層だけで戦うのをやめ、**ターミナルで真実（証拠）を取りにいく**。

### 用語（最低限）
- **閉域網**：インターネットへ自由に出られず、通信が統制されたネットワーク。
- **ターミナル／CLI**：コマンドで操作し、ログ・状態を直接観測できる入口。
- **切り分け**：原因を推測で語らず、レイヤごとに「ここまではOK」を積み上げる手法。

### Tips（実務）
- 「繋がらない」を **一発で直す**より、**再発時に同じ型で直せる**ようにするのが最強です。

---

# 2. なぜ、今「黒い画面」なのか？
![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨
- **The Trap（罠）**：GUIの「接続できません」は、原因を隠す（情報が足りない）。
- **The Solution（解）**：CLIで **診断ログを出して、原因を特定**する。

### ありがちな誤解
- ❌「ブラウザで見れる＝環境OK」  
  → ✅ OSサービス（WinHTTP）や開発ツール（Docker/npm/pip）は別経路で失敗します。

### Tips（実務）
- 閉域網の敵は、だいたいこの3つ：  
  1) **プロキシ**（出口の門番）  
  2) **SSL検査**（証明書の検問）  
  3) **権限制限**（通行手形不足）

---

# 3. 聴診器：curl（Basic）
![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨
curlはダウンローダーではなく、**通信のどこで止まったか**を観測する「聴診器」。

### コマンド解説（Cheat Sheet）
#### 1) 生存確認（Survival Check）
```bash
curl -I https://site
````

* `-I`：本文を取らず **ヘッダーだけ**取得（速い・安全）
* 目的：まず「HTTP(S)が成立するか」を見る

#### 2) 追跡（Follow the Path）

```bash
curl -L https://site
```

* `-L`：301/302 の **リダイレクトを自動追従**
* 閉域網はゲートウェイや認証基盤でリダイレクトが多い

#### 3) 詳細診断（Verbose Mode）

```bash
curl -v https://site
```

* `-v`：DNS → TCP → TLS → HTTP の進行がログで見える

### 用語

* **ヘッダー**：HTTPのメタ情報（ステータス、Location、認証方式など）
* **リダイレクト**：別URLへ誘導（認証ページや別ドメインへ飛ばされる）

### Tips（実務）

* `-k/--insecure` は **「証明書エラーの診断」**にだけ使う最終手段。
  恒久策にすると事故の元（本番や機密では禁止）。

---

# 4. 障壁突破：curl（Proxy & Auth）

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

閉域網は「プロキシという門」を越えないと外へ出られない。
curlで **プロキシ指定**と **認証**を明示して突破する。

### コマンド解説

#### 1) プロキシ指定（URLに認証も含める書き方）

```bash
curl -x http://user:pass@proxy:8080 https://target
```

* `-x`：プロキシを指定（`--proxy` と同義）
* 注意：履歴に残りやすい（パスワード直書きは事故りやすい）

#### 2) 推奨：認証は別で渡す（より安全）

```bash
curl -x http://proxy:8080 -U user https://target
```

* `-U`：プロキシ認証（`--proxy-user`）
* 実務では `user:pass` を後入力にしたり、秘密管理へ寄せるのが安全

### 重要：特殊文字はURLエンコード

* パスワードに `@` や `:` があると、URLの区切りと誤認される
* 例：`@` → `%40`

  * Bad：`user:p@ssword@proxy`
  * Good：`user:p%40ssword@proxy`

### Tips（実務）

* **パスワードはコマンドに残さない**が基本（履歴・ログ・スクショで漏れます）。
* まずは `-v` で `Connected to proxy` まで到達できるか確認すると最短。

---

# 5. 精密検査：curl（Performance）

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

「遅い」の犯人を **DNS / TCP接続 / 全体** に分解して特定する。

### コマンド解説（時間内訳を出す）

```bash
curl -w "DNS: %{time_namelookup}\nConnect: %{time_connect}\nTotal: %{time_total}\n" \
  -o /dev/null -s https://google.com
```

* `-w`：計測結果（変数）を出力
* `-o /dev/null`：本文を捨てる（計測を軽くする）
* `-s`：進捗表示を抑制（スクリプト向き）

### 用語

* `time_namelookup`：DNS（名前解決）時間
* `time_connect`：TCP接続時間（プロキシ到達/確立含むことが多い）
* `time_total`：全体（HTTP完了）まで

### Tips（実務）

* **DNSだけ遅い**：社内DNS、名前解決ポリシー、VPN経路を疑う
* **Connectが遅い**：プロキシ混雑、FW、経路の問題
* **Totalだけ遅い**：サーバ側処理/API側性能（ネットではない可能性）

---

# 6. 第六感：Test-NetConnection（tnc）

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

閉域網では **ICMP（ping）が殺されている**ことが多い。
でも **TCPポートは生きている**ことがある。pingで判断してはいけない。

### コマンド解説（TCP疎通確認）

```powershell
tnc google.com -Port 443
# （正式名）Test-NetConnection google.com -Port 443
```

* `TcpTestSucceeded: True` なら **443への到達はOK**
* pingがタイムアウトでも、Web（HTTPS）が成立することは普通にある

### 用語

* **ICMP（ping）**：ネットワーク診断用の通信。閉域網ではブロックされがち
* **TCP 443**：HTTPSの標準ポート（最優先で確認する価値が高い）

### Tips（実務）

* 最初に `tnc` を打つだけで、「ネットワークが死んでる」論争が終わります。
* 443が通るなら、次は `curl -v` で **プロキシ／証明書／HTTP** を確定する。

---

# 7. サバイバルナイフ：netsh（WinHTTP）

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨（超重要）

Windowsには「二重プロキシ問題」がある：

* **WinINet**：ブラウザ（Edge等）が使う
* **WinHTTP**：Windows Update / システム系が使う
  ブラウザOKでも、WinHTTPが未設定だとシステム系が死ぬ。

### コマンド解説

#### 1) 現状確認

```bat
netsh winhttp show proxy
```

#### 2) ブラウザ設定をOSへコピー（最短の定番）

```bat
netsh winhttp import proxy source=ie
```

### 用語

* **WinINet**：ユーザーのプロキシ設定（ブラウザ寄り）
* **WinHTTP**：OSサービス向けプロキシ設定（システム寄り）

### Tips（実務）

* 「Updateだけ失敗」「一部のインストーラだけ失敗」は、まずここを疑う。
* 組織ルールで変更禁止のこともあるので、必要なら手順を残してインフラへ相談。

---

# 8. 環境適応：netsh（WLAN & Interface）

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

* Wi-Fiは「体感」ではなく **数値**で見る（Signal/チャンネル干渉）
* 現場は「固定IP（検証室）」と「DHCP（自席）」を行き来する
  → ワンクリック切替で事故を減らす

### コマンド解説（Wi-Fiの可視化）

```bat
netsh wlan show interfaces
```

* `Signal: 80%` のように強度が出る（低いと不安定）

```bat
netsh wlan show networks mode=bssid
```

* 周囲APのBSSID/チャンネルが見える
* 同一/近傍チャンネルが多いと干渉しやすい

### コマンド解説（IP切替の基本）

```bat
netsh interface ip set address "Ethernet" dhcp
netsh interface ip set address "Ethernet" static <IP> <MASK> <GW>
```

### Tips（実務）

* IP切替は **バッチ化**が最強（ミスが減る／復帰が速い）。
* Wi-Fiが怪しいときは、まず `show interfaces` でSignalを証拠化してから席移動や帯域変更を検討。

---

# 9. 大気成分：環境変数（Variables）

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

ツールごとに「方言（設定場所）」が違う。
OS環境変数だけでは足りないことがある（npm/Gitなどは独自設定が強い）。

### 代表例（ツール別）

#### npm（Node.js）

```bash
npm config set proxy http://proxy:8080
npm config set https-proxy http://proxy:8080
```

#### Git

```bash
git config --global http.proxy  http://proxy:8080
git config --global https.proxy http://proxy:8080
```

#### OS（共通）

* `HTTP_PROXY` / `HTTPS_PROXY`
* **NO_PROXY**（最重要）

### NO_PROXYが最重要な理由

`NO_PROXY` がないと、社内システム（localhostや社内ドメイン）まで外部プロキシへ行き、
**ループ／拒否／名前解決不整合**で死にます。

例（概念）：

* `localhost,127.0.0.1,company.local`

### Tips（実務）

* まずNO_PROXYは最小（`localhost,127.0.0.1`）から開始し、必要な社内ドメインを段階的に追加。
* 「Dockerの中だけ繋がらない」は、環境変数の渡し漏れ（build/run）も疑う。

---

# 10. 状況把握：systeminfo & wmic

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

「この船（マシン）は今どういう状態か」を把握しないと、対処がブレる。
特に閉域網は **端末準拠（パッチ状況・ドメイン・GPO）** が効いてくる。

### コマンド解説

#### スペック・OS状態

```bat
systeminfo
```

* OSバージョン、稼働時間、ドメイン参加状況などを一括で確認

#### 資産情報（端末管理で聞かれがち）

```bat
wmic bios get serialnumber
```

#### セキュリティ（パッチ適用状況）

```bat
wmic qfe list
```

* インストール済み更新（修正パッチ）一覧

### Tips（実務）

* 管理者に相談するとき、`systeminfo` と `wmic qfe list` を添付できると会話が早い。
* 端末情報（シリアル等）は取り扱いに注意（社内ルールに従う）。

---

# 11. ID確認：whoami

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

「Access Denied」の正体は、技術ではなく **権限（政治）** のことが多い。
まずは自分の所属・権限を可視化して、議論を終わらせる。

### コマンド解説

#### 所属グループ（Admin権限の有無など）

```bat
whoami /groups
```

#### 付与されている特権（バックアップ等）

```bat
whoami /priv
```

### Tips（実務）

* 「技術の問題」か「権限の問題」かを分離するのが第一歩。
* GPOやEDRで制限されている場合、回避ではなく **申請・相談**が正解（監査で詰む）。

---

# 12. 動体視力：Get-Content -Wait

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

エラーは一瞬で流れる。
Windowsでも `tail -f` のようにログを追従し、**発生の瞬間を目撃**する。

### コマンド解説（PowerShell）

```powershell
Get-Content .\log.txt -Wait
```

#### さらに実務向け（最後のN行から開始）

```powershell
Get-Content .\log.txt -Wait -Tail 50
```

### 運用の型

1. 先に `-Wait` で監視開始
2. エラーを再現
3. `Ctrl + C` で停止（必要箇所だけ保存・共有）

### Tips（実務）

* 共有するログは **トークン/キー/個人情報**を必ずマスク。
* ログローテーションがある場合、ファイルが切り替わって追いにくいので運用に注意。

---

# 13. 暗号解読：openssl（SSL/TLS）

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

証明書エラーの犯人を探す。
閉域網では、企業プロキシ（Zscaler/BlueCoat等）が **SSLインスペクション**を行い、発行者（Issuer）が企業CAに置き換わることがある。

### コマンド解説（証明書チェーンを見る）

```bash
openssl s_client -connect google.com:443 -showcerts
```

#### ここを見る（最重要）

* **Issuer（発行者）** が `Google Trust Services` ではなく
  `MyCompany Proxy CA` のようになっていたら、SSL検査が介在している可能性が高い
  → **社内ルート証明書のインポート／信頼設定**が必要

### 用語

* **TLSハンドシェイク**：暗号方式合意・証明書検証の手続き
* **証明書チェーン**：サーバ証明書 → 中間CA → ルートCA の連なり
* **ルートCA**：信頼の起点（これを信頼しないとチェーンが成立しない）

### Tips（実務）

* `curl -v` で「証明書で死んでる」まで分かったら、`openssl` で **Issuer確定**が最短。
* 正攻法：社内配布のルート証明書を、OS/ツールに正しく登録する。

---

# 14. 緊急回避：Emergency & Efficiency

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

制限された環境では「正確な報告」と「最小の突破口」が生死を分ける。
ただし **回避は“許可された手順”の範囲で**行う（勝手な迂回は監査で終わる）。

---

## 14-1. Breaking the Glass（正規の緊急導線）

* Task Manager から「Run new task」を使い、必要に応じて管理者として起動する手段がある
* **前提**：組織の運用で許可された“ブレイクグラス”手順として扱うこと（無断でやらない）

### Tips（実務）

* 目的は「回避」ではなく **復旧のための正規導線**。
* 実行ログ・理由・作業内容を簡潔に残すと、後で揉めない。

---

## 14-2. The Clip Trick（正確さで勝つ）

```bat
ipconfig | clip
```

* `clip`：標準出力をクリップボードへ送る
* 目的：マウス選択でログを取りこぼさず、**正確に報告**する

### 追加Tips（現場で強い）

* ネットワーク報告テンプレ（例）：

  * `ipconfig /all`（必要箇所をマスク）
  * `tnc <host> -Port 443` 結果
  * `curl -v <url>` のうち、認証情報をマスクした部分

---

# 15. エンジニアの流儀（Manifesto）

![cdp1.閉域網の達人になる：コマンドラインサバイバルキット](/images/network/cdp1.閉域網の達人になる：コマンドラインサバイバルキット.jpg)

### 図の要旨

コマンドラインは、単なる文字の羅列ではない。
それは **「推測」を「確認」に変える**ための道具。

### ここまでの総括（レイヤで考える）

* DNS（名前解決）
* TCP（到達性）
* TLS（証明書・検問）
* HTTP（認証・仕様）
* 権限（GPO/グループ/特権）
* 端末状態（パッチ・ドメイン）

このレイヤを正しく切り分けられる者だけが、閉域網で問題を解決できる。

> Equip your kit. Stay sharp.（装備を整えよ。生き残れ。）
