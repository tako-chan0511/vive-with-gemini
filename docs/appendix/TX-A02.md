## Saga設計チェックリスト（冪等性・補償・DLQ・監査）

![TX-A02](/images/gamehub/TX-A02.jpg)

## このページ（上記図の説明）の目的

Sagaパターンで整合性を作るときに、設計・実装・運用で抜け漏れが出やすいポイントを **チェックリスト化**します。
「理論は分かったが実装で破綻した」を避けるための実務ガイドです。

---

## 1. Sagaの前提（3行で）

* Saga = **複数ステップ（ローカルトランザクション）の連鎖**
* 途中失敗したら **補償（Compensation）**で戻す、または**リトライ**で前進する
* “分散ロールバック”ではなく、**業務的に整合する状態へ収束**させる

---

## 2. まず決める：成功条件と整合の定義

* 「整合している」とは具体的に何か？

  * 例：会員作成は *EC・CS・会員DB* の3点セットが揃った状態を成功とする
* “部分成功”を許すか？

  * 例：ECは遅延OK、ただし会員DBは即時反映必須

この定義が曖昧だと、補償や再試行の判断がブレます。

---

## 3. 冪等性（Idempotency）チェック

### 3.1 何を保証するか

* 同じ要求を複数回実行しても「結果が1回実行と同じ」になること

### 3.2 実装パターン

* **Idempotency Key**（例：`request_id` / `transaction_id`）を全ステップに渡す
* DBで「既に処理済み」を記録（重複実行をショートカット）
* 外部APIは、可能なら“重複作成防止”のキーを利用

### 3.3 チェック項目

* [ ] タイムアウト後の再送で二重作成しないか
* [ ] リトライが原因で状態が壊れないか
* [ ] 補償も冪等（“既に消えている”を成功扱いできるか）

---

## 4. 補償（Compensation）チェック

### 4.1 補償は“逆操作”ではない場合がある

* 作成の補償：削除 or 無効化
* 更新の補償：前の値に戻す（前状態の保存が必要）
* 通知・課金など副作用は完全に消せない場合がある

### 4.2 チェック項目

* [ ] 各ステップに補償手段が存在するか（API/DB操作/無効化）
* [ ] 補償の順序は妥当か（逆順が基本）
* [ ] 補償失敗時の扱いが決まっているか（手動介入・再試行）
* [ ] 補償不能な副作用の扱いが合意されているか（監査/通知）

---

## 5. タイムアウトとリトライ戦略

### 5.1 推奨の基本形

* 短いタイムアウト + 再試行（指数バックオフ）
* “永久リトライ”は避ける（上限回数/期限を設ける）

### 5.2 チェック項目

* [ ] リトライ回数上限があるか
* [ ] バックオフ（指数）になっているか
* [ ] 外部SaaSごとにタイムアウト/リトライを分離できるか
* [ ] 429（レート制限）や 5xx で挙動が違うか

---

## 6. 状態管理（Saga State / Progress）

Sagaは「どこまで成功したか」を記録できないと、復旧不能になります。

### 6.1 状態に含めるべき情報（最低限）

* `transaction_id`
* `current_step`
* 各ステップの `status`（SUCCEEDED/FAILED/PENDING）
* `retry_count`
* `last_error`
* `timestamps`（開始/更新/最終）

### 6.2 チェック項目

* [ ] 途中失敗後に再開できるか（再実行ポイントが明確か）
* [ ] 再実行が冪等に動くか
* [ ] 手動復旧者が判断できる情報が揃っているか

---

## 7. DLQ（Dead Letter Queue）と運用

非同期（SQS等）を使う場合、DLQは“墓場”ではなく“回復の入口”です。

### 7.1 チェック項目

* [ ] DLQの到達条件（最大受信回数など）が決まっているか
* [ ] DLQメッセージに復旧に必要な情報が入っているか
* [ ] DLQ監視（アラーム）があるか
* [ ] 再投入（re-drive）手順があるか（手動/自動）

---

## 8. 監査・観測性（Observability）

分散トランザクションは「見えないと運用できない」領域です。

### 8.1 チェック項目

* [ ] 相関ID（correlation id）が全ステップに伝播しているか
* [ ] ログは構造化され検索できるか（JSON等）
* [ ] 主要メトリクス（成功率・遅延・DLQ件数）があるか
* [ ] 異常検知（アラーム）から復旧までの導線があるか

---

## 9. 最終チェック：人が安心して運用できるか

* [ ] “失敗が起きたときの復旧手順書（Runbook）”があるか
* [ ] “手動介入が必要な境界”が定義されているか
* [ ] 本番での再実行・補償が安全にできるか（権限・監査）

次ページ TX-A03 で、AWS上での代表的な実装パターンに落とします。
