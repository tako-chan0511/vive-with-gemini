# 同期・非同期アーキテクチャ図（解説付き）

> 図は Mermaid を **`<pre class="mermaid" v-pre>`** で描画します。  
> サイドバー遷移でテキストのまま残る環境では、ページ表示直後に自動レンダリングされる設定を入れてください。

<pre class="mermaid" v-pre>
flowchart TD
%% --- subgraphs (ASCII id + JP label) ---
subgraph users["ユーザー"]
  Client[クライアント／ブラウザ]
end
subgraph app["アプリケーションサーバー"]
  API[FastAPI API サーバー]
  Worker[ワーカー（非同期処理）]
  BL[ビジネスロジック]
end
subgraph ext["外部サービス"]
  SQS[Amazon SQS（キュー）]
  DB[(PostgreSQL)]
end

%% --- 同期（実線） ---
Client -->|"同期リクエスト<br/>GET /recipe/123"| API
API -->|"直接呼び出し"| BL
BL -->|"データ読み書き"| DB
DB -->|"結果"| BL
BL -->|"結果"| API
API -->|"同期レスポンス<br/>JSON"| Client

%% --- 非同期（点線） ---
Client -.->|"非同期リクエスト<br/>POST /generate-report"| API
API -.->|"202 Accepted"| Client
API -.->|"キュー投入"| SQS
SQS -.->|"ポーリング"| Worker
Worker -.->|"処理依頼"| BL
BL -.->|"重い処理（書き込み等）"| DB
</pre>

---

## 1. サブグラフと要素の説明

### ユーザー (`users`)
- **クライアント／ブラウザ（Client）**  
  人間の操作や自動クライアントが API を呼び出す起点。同期処理では結果を待ち、非同期処理では即応答を受けて後続を待たない。

### アプリケーションサーバー (`app`)
- **FastAPI API サーバー（API）**  
  受け口。HTTP リクエストを受け、軽い処理はそのまま同期で返す。重い処理はキューに積んですぐ 202 を返す。
- **ビジネスロジック（BL）**  
  ドメイン規約・入力検証・権限・集計などアプリの核心。同期/非同期どちらからも呼ばれる。
- **ワーカー（Worker）**  
  バックグラウンド実行専用プロセス。SQS をポーリングし、受け取ったジョブを **BL** に委譲して実行。

### 外部サービス (`ext`)
- **Amazon SQS（SQS）**  
  非同期ジョブを蓄えるキュー。冪等性キーや可視性タイムアウト設定で再実行・重複に耐える設計が可能。
- **PostgreSQL（DB）**  
  主要ストア。同期/非同期ともに読み書きする。トランザクション/ロック設計が性能と整合性の要。

---

## 2. フロー説明

### 同期（実線）
1. **Client → API：** `GET /recipe/123` などの**同期リクエスト**を送信。  
2. **API → BL：** API は**直接**ビジネスロジックを呼び出す。  
3. **BL → DB：** 必要なデータを**読み書き**。  
4. **DB → BL：** クエリ**結果**を返す。  
5. **BL → API：** 処理**結果**を返却。  
6. **API → Client：** **同期レスポンス（JSON）** を返す（例：200 OK）。  
> 特徴：待ち時間＝処理時間。ユーザーが結果をすぐに必要とする場面向け。

### 非同期（点線）
A. **Client → API：** `POST /generate-report` など**非同期リクエスト**を送信。  
B. **API → Client：** 受理のみ行い **`202 Accepted`** を即返す（ジョブID等を返すと良い）。  
C. **API → SQS：** リクエスト内容を**キュー投入**（冪等性キー推奨）。  
D. **SQS → Worker：** ワーカーが**ポーリング**してメッセージを取得。  
E. **Worker → BL：** メッセージに基づいて BL に**処理依頼**。  
F. **BL → DB：** **重い処理**（集計・書き込み等）を実施し永続化。  
> 特徴：応答は即時、実処理はバックグラウンド。長時間処理・ピーク平準化・再試行に強い。

---

### 運用メモ（参考）
- **冪等性**：キュー投入時に重複禁止キー（例：`job_key`）を付与し、DB 側でも一意制約で多重実行を抑止。  
- **再試行**：失敗時は可視性タイムアウト後に再配信。BL は**副作用の再実行**に耐える設計に。  
- **進捗通知**：ポーリング API・WebSocket・Webhook のいずれかでクライアントに完了/失敗を通知。  
- **監視**：SQS のキュー長/遅延、Worker の処理時間、DB のロック待ちをメトリクス化。
