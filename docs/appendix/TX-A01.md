# 分散トランザクション総論（2PC / XA / CAP / 結果整合）

![TX-A01](/images/gamehub/TX-A01.jpg) 

## このページ（上記図の説明）の目的

分散システム（複数DB、複数サービス、外部SaaS/API）で「トランザクション整合性」を扱うときに、**何が難しく、どんな選択肢があり、現代の実務ではどこに落としどころを作るのか**を、初学者にも分かるように整理します。

---

## 1. そもそもトランザクションとは（単一DBの世界）

単一DBのトランザクションは、一般に **ACID** を目標に設計されます。

* **Atomicity（原子性）**：全部成功か全部失敗か
* **Consistency（一貫性）**：整合性制約を破らない
* **Isolation（独立性）**：同時実行でも結果が壊れない
* **Durability（耐久性）**：コミットしたら消えない

典型例：注文作成で「在庫を引く」「注文行を作る」「支払いステータスを更新する」を1つのDB内でやるなら、`BEGIN … COMMIT/ROLLBACK` で成立しやすいです。

---

## 2. “分散”すると何が起きるか（複数リソース）

分散（Distributed）とは、更新対象が複数の「トランザクション境界」に分かれている状態です。

* DBが複数（例：マイクロサービスごとにDBが別）
* 外部SaaS（例：CRM、EC、CSツール）も更新対象
* ネットワーク越し（通信失敗・遅延・部分成功）が当たり前

ここで問題になるのは、**単一DBのROLLBACKが効かない**ことです。

* DB A は更新済み
* 外部SaaS は更新失敗
* しかし「DB A を元に戻せ」だけでは整合性が戻らないことがある（副作用が残る）

---

## 3. 2PC（Two-Phase Commit）とは何か

**2PC** は「複数の参加者（DBなど）にまたがって、全員がコミットできるかを確認してから一斉コミットする」方式です。

### 3.1 2PC の流れ（概念）

1. **Prepare フェーズ**：参加者に「コミット可能か？」を問い合わせ、全員がOKなら“準備完了”
2. **Commit フェーズ**：全員にコミット指示（誰かNGならアボート）

### 3.2 2PC の長所

* “全部成功 or 全部失敗” を**理想形で**実現しやすい
* DB間の整合性を強く保てる

### 3.3 2PC の短所（実務で避けられがちな理由）

* **外部SaaSは2PCに参加してくれない**（Prepare/Commitのプロトコルがない）
* Coordinator障害時の扱いが難しく、**ブロッキング**が起きる（待ち続ける参加者）
* 高遅延・高可用性環境で性能/運用コストが高い

結論：2PCは「DBなど同種リソース同士の統制」に向く一方、**API統合（SaaS含む）では現実的でないことが多い**です。

---

## 4. XA（分散トランザクション）とは何か

**XA** は「トランザクションマネージャ（TM）が複数のリソースマネージャ（RM）を束ねる」枠組みです。実装として 2PC が使われることが多いです。

* 典型：アプリサーバ（TM）が DB1/DB2（RM） を束ねる
* しかし外部APIはRMになりづらい

結論：XAは“古典的なエンタープライズ統合”では重要ですが、**マイクロサービス/サーバーレス+外部SaaS**の文脈では適用範囲が狭まります。

---

## 5. CAP定理と整合性の現実（ざっくり理解）

分散では、しばしば **CAP** のトレードオフが説明に使われます。

* **C**：Consistency（整合性）
* **A**：Availability（可用性）
* **P**：Partition tolerance（分断耐性：ネットワーク断を許容）

ネットワーク断（P）が現実に起きる以上、**CとAを同時に100%は満たせない**という説明です。
実務では、要件に応じて「どの程度の整合性を、どの範囲で、どのタイミングで」満たすかを設計します。

---

## 6. 結果整合（Eventual Consistency）と“正しい”不整合

**結果整合**は「直後はズレていても、最終的に一致する」整合性モデルです。

### 6.1 いつ採用されるか

* 外部SaaS統合、イベント駆動、非同期処理
* 高可用性、スケール、レート制限回避を重視

### 6.2 何を設計しないと破綻するか

結果整合は“魔法”ではなく、次が必須です。

* **状態管理**：どこまで処理が進んだか（進捗、失敗理由）
* **再試行**：失敗は前提。自動/手動の復旧手段が必要
* **冪等性**：同じイベントが重複しても壊れない
* **観測性**：相関ID、ログ、アラート、DLQ

---

## 7. まとめ：分散トランザクションで最初に決めること

初学者が迷いがちな点を「問い」に落とします。

1. **強整合が本当に必要か？**（ユーザー体験/監査要件/法規制）
2. 失敗時に「戻す」か「進める」か（補償 vs リトライ継続）
3. 最終整合の責任はどこに置くか（オーケストレーター/イベント駆動）
4. 運用で回す前提か（DLQ/手動復旧/監査）

次ページ TX-A02 で、Sagaを採用する場合を詳細に説明します。
