# 正規表現（Regex）実務入門：開発効率を変える10の処方箋

---

## １　ログ調査からリファクタリングまで「本当に使える」Regex

![re1.正規表現（Regex）実務入門：開発効率を変える10の処方箋](/images/gamehub/re1.正規表現（Regex）実務入門：開発効率を変える10の処方箋.jpg)

### 図の要旨
- 雑多なログ/テキストから、Regexで「構造化された情報」を抽出・整形できる。
- 調査（検索）→修正（置換）→安全化（マスキング）までが守備範囲。

### 詳細解説
- Regexは「人間の目で探す」を「機械で見つける」に置換する道具。
- 目視は “抜け” と “思い込み” が起きやすいが、Regexは条件を固定できる。

### Tips（実務で効く使い方）
- ログ調査の基本は「まずヒット条件を狭く作り、徐々に広げる」。
  - 例：`ERROR`固定 → `ERROR|WARN` → `timeout|deadline|504` のように拡張

---

## ２ なぜ正規表現が必要なのか：ツールの裏側にある共通言語

![re2.なぜ正規表現が必要なのか？](/images/gamehub/re2.なぜ正規表現が必要なのか？.jpg)

### 図の要旨
- grep/rg（検索）、sed（置換）、VS Code（検索/置換）、Vim（編集）、Python/JS（処理）をRegexが横断する。

### 詳細解説
- 「ツールごとの習熟」ではなく「Regexという共通エンジン」を覚えると投資効率が高い。
- 開発現場では、検索→抽出→置換→検証のループが頻出。

### Tips（実務で効く使い方）
- まず “自分がよく使う2つ” に集中すると定着が速い。
  - 例：`rg`（検索）＋`VS Code置換`（修正） あるいは `rg`＋`sed`（大量置換）

---

## ３ 始める前の重要事項：Regexの「方言」を知る（POSIX / PCRE）

![re3.始める前の重要事項：Regexの「方言」を知る](/images/gamehub/re3.始める前の重要事項：Regexの「方言」を知る.jpg)

### 図の要旨
- POSIX（古典/機能限定）とPCRE（高機能/Perl互換）で “同じRegexのつもり” が動かないことがある。

### 詳細解説
- 典型的な事故：**先読み/後読み（look-around）**を使ったら `rg` でエラー。
- 重要ポイント：
  - `grep` / `sed` はPOSIX寄り（BRE/ERE）
  - `VS Code` / `Python` / `JavaScript` は比較的モダン
  - `ripgrep (rg)` は **デフォルトはRust Regex（高速だがlook-around非対応）**  
    → 必要なら **PCRE2モード**を使う

### Tips（実務で効く使い方）
- `rg`で先読み/後読みを使いたい場合：
  - `rg -P 'consul(?!t)'`（`-P`はPCRE2）
- `sed`で `{m,n}` や `+` を素直に使いたい場合：
  - `sed -E 's/old/new/g'`（`-E`で拡張正規表現：ERE）

---

## ４ Recipe 01：ノイズを消し去る「OR検索」複数キーワードを一度に

![re4.ノイズを消し去る「OR検索」](/images/gamehub/re4.ノイズを消し去る「OR検索」.jpg)

### 図の要旨
- `|`（パイプ）で OR 条件：必要なログだけをまとめて拾う。

### 詳細解説
- 例：障害調査で `ERROR` と `WARN` を同時に拾うと見落としが減る。
- Regex：`ERROR|WARN` は「ERROR または WARN」。

### Tips（実務で効く使い方）
- ripgrep：
  - `rg -n 'ERROR|WARN' app.log`
- “語彙揺れ” も OR で吸収：
  - `rg -n 'timeout|deadline|504|ETIMEDOUT' app.log`

---

## ５ Recipe 02：位置を固定する「アンカー」部分一致ノイズを排除

![re5.位置を固定する「アンカー」](/images/gamehub/re5.位置を固定する「アンカー」.jpg)

### 図の要旨
- `^`（行頭）と `$`（行末）で「どこに現れるか」を固定して誤ヒットを減らす。

### 詳細解説
- `TODO` を探したいが `SOMETHING_TODO` まで拾うとノイズ。
  - `^TODO`：行頭がTODO
- 文末の記号（例：`;`）を狙うなら：
  - `;$`：行末がセミコロン

### Tips（実務で効く使い方）
- “設定行” だけ拾う：
  - `rg -n '^export ' .env*`
- “末尾空白” を検知（地味にバグ源）：
  - `rg -n ' +$' *.py`

---

## ６ Recipe 03：単語の境界線「ワードバウンダリ」安全なリファクタリング

![re6.単語の境界線「ワードバウンダリ」](/images/gamehub/re6.単語の境界線「ワードバウンダリ」.jpg)

### 図の要旨
- `\b` を使うと “単語としての一致” になり、部分一致による誤置換を防げる。

### 詳細解説
- `id` を置換したら `user_id` や `order_id` まで壊す、が典型事故。
- `\buser_id\b` のように境界を入れると「単語」単位になる。

### Tips（実務で効く使い方）
- `rg`（単語境界で安全に検索）：
  - `rg -n '\buser_id\b'`
- VS Code置換（まず検索で件数/対象を確認してから置換）：
  - 検索：`\buser_id\b`
  - 置換：`customer_id`

---

## ７ Recipe 04：揺らぎを許容する「文字クラス」フォーマット一致

![re7.揺ぎを許容する「文字クラス」](/images/gamehub/re7.揺ぎを許容する「文字クラス」.jpg)

### 図の要旨
- `[0-9]` や `{2}` を使って「形式で探す」（例：2桁数字のID）。

### 詳細解説
- `user_01` `user_99` はOK、`user_ab` はNG、のような要件はRegexが得意。
- 例：`user_[0-9]{2}`（2桁の数字）

### Tips（実務で効く使い方）
- “連番チケット” を拾う：
  - `rg -n 'SSR-[0-9]{3,5}'`
- UUIDっぽい文字列を拾う（簡易版）：
  - `rg -n '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' --ignore-case`

---

## ８ Recipe 05：ワイルドカードの罠（貪欲/非貪欲）

![re8.何でもマッチする「ワイルドカード」の罠](/images/gamehub/re8.何でもマッチする「ワイルドカード」の罠.jpg)

### 図の要旨
- `.*` は貪欲（最長一致）になりやすい。必要なら `.*?`（最短一致）を使う。

### 詳細解説
- `name="foo" class="bar"` から `foo` を抜きたいのに、
  - `".*"` だと `"foo" class="bar"` まで飲み込む事故が起きる。
- `".*?"` は最短で止まるので、抽出に向く。

### Tips（実務で効く使い方）
- “ダブルクォート内” を抜きたいときの基本形：
  - `"[^"]*"`（こちらは貪欲/非貪欲の混乱が少なく実務向き）
- HTML属性値抽出（例：name="..."）：
  - `rg -n 'name="[^"]*"' file.html`

---

## ９ Recipe 06：記号そのものを探す「エスケープ」

![re9.記号そのものを探す「エスケープ」](/images/gamehub/re9.記号そのものを探す「エスケープ」.jpg)

### 図の要旨
- `.` や `[` や `$` などはRegexの特殊文字。文字として扱うには `\` でエスケープ。

### 詳細解説
- 例：ドット `.` は “任意の1文字”。
  - “ピリオドそのもの” を探すなら `\.`

### Tips（実務で効く使い方）
- 拡張子 `.env` を確実に拾う：
  - `rg -n '\.env(\.|$)'`
- 角括弧つきログ（例：`[INFO]`）を探す：
  - `rg -n '\[INFO\]|\[ERROR\]' app.log`

---

## １０ Recipe 07：除外して絞り込む「否定」

![re10.除外して絞り込む「否定」](/images/gamehub/re10.除外して絞り込む「否定」.jpg)

### 図の要旨
- 「欲しいもの」を定義するより「要らないものを除外」した方が早い場面がある。
- 文字クラス内の `^` は否定：`[^0-9]`（数字以外）

### 詳細解説
- `[^0-9]` は “数字以外の1文字”。
- `rg -v` は “マッチした行を除外” で、調査で非常に強い。

### Tips（実務で効く使い方）
- “正常行を除外して異常だけ”：
  - `rg -v 'INFO|DEBUG' app.log`
- “数字だけの行以外を除外”：
  - `rg -n '^[0-9]+$' data.txt`

---

## １１ Recipe 08：文字列を一括変換する「単純置換」（sed）

![re11.文字列を一括変換する「単純置換」](/images/gamehub/re11.文字列を一括変換する「単純置換」.jpg)

### 図の要旨
- `sed 's/old/new/g'` で、行内の一致を一括置換できる（`g`は全置換）。

### 詳細解説
- 構文：`s / 検索 / 置換 / フラグ`
  - `s`：substitute
  - `g`：行内の全ヒットを置換

### Tips（実務で効く使い方）
- まずは “上書きしない” で目視確認：
  - `sed -E 's/http:/https:/g' file.txt | head`
- 上書き（最終手段）：
  - `sed -E -i 's/http:/https:/g' file.txt`
  - ※macOSとGNUで `-i` の扱いが違う場合があるため、プロジェクト標準を決めると安全

---

## １２ Recipe 09：構造を組み替える「キャプチャと参照」

![re12.構造を組み替える「キャプチャと参照」](/images/gamehub/re12.構造を組み替える「キャプチャと参照」.jpg)

### 図の要旨
- `(...)` でマッチ部分を保持し、` \1 \2 ...` で再利用して出力形式を組み替える。

### 詳細解説
- 例：`2023-12-25`
  - パターン：`(\d{4})-(\d{2})-(\d{2})`
  - 置換：`\2/\3/\1` → `12/25/2023`

### Tips（実務で効く使い方）
- ツールごとの参照記法の違いに注意：
  - `sed`：`\1`
  - VS Code置換：`$1`
  - Python `re.sub`：`\1`（raw文字列推奨：`r'\1'`）
- VS Codeで日付フォーマットを変える例：
  - 検索：`(\d{4})-(\d{2})-(\d{2})`
  - 置換：`$2/$3/$1`

---

## １３ Recipe 10：機密情報を守る「マスキング」（ログ共有前処理）

![re13.機密情報を守る「マスキング」](/images/gamehub/re13.機密情報を守る「マスキング」.jpg)

### 図の要旨
- パスワード等をRegexで検出し、共有前に伏字化する。

### 詳細解説
- 例：`password=SuperSecret123&lang=en`
  - `password=` 以降、次の `&` までが機密
  - パターン：`(password=)[^&]*`
  - 置換：`\1*****`

### Tips（実務で効く使い方）
- `sed`（ERE）で一括マスク：
  - `sed -E 's/(password=)[^&]*/\1*****/g' access.log`
- 追加でよくあるマスク対象（例）：
  - `Authorization: Bearer <token>` → `Bearer *****`
  - `api_key=...` / `token=...` / `secret=...` などは同様に `(key=)[^& ]*` の形で作る

---

## １４ 安全な置換のための「3ステップ・プロトコル」

![re14.安全な置換のための「3ステップ＆プロトコル」](/images/gamehub/re14.安全な置換のための「3ステップ＆プロトコル」.jpg)

### 図の要旨
- Regex置換の事故（誤置換）を防ぐための鉄則：SEARCH → PREVIEW → EXECUTE。

### 詳細解説
1) SEARCH（確認）
- `rg/grep`で “意図した行だけ” ヒットするか確認（件数も見る）

2) PREVIEW（予行演習）
- `sed` は “上書き無し” で流し、標準出力を目視確認（必要なら差分ツール）

3) EXECUTE（実行）
- 確信が持てた時だけ `-i`（上書き）

### Tips（実務で効く使い方）
- 置換の前に Git を使って “戻れる状態” にする（強く推奨）：
  - `git status` → `git add -A` → `git commit -m "pre-regex-replace"` のように保険を張る
- 大規模置換は「対象ファイルを絞る」「段階コミット」をセットで行うと事故が減る

---

## １５ Developer’s Regex Cheat Sheet（最低限これだけ）

![re15.DevelopersRegexCheatSheet](/images/gamehub/re15.DevelopersRegexCheatSheet.jpg)

### 図の要旨
- よく使う記号の一覧（Regexの最小セット）。

### 詳細解説
- `.`：任意の1文字
- `*`：直前要素の0回以上（貪欲）
- `+`：直前要素の1回以上（貪欲）
- `?`：直前要素の0回または1回
- `\d`：数字、`\w`：単語文字、`\s`：空白
- `\b`：単語境界
- `^`：行頭、`$`：行末
- `|`：OR
- `\`：エスケープ
- `[...]`：文字クラス、`[^...]`：否定
- `(...)`：グループ、`\1`：参照

### Tips（実務で効く使い方）
- 迷ったらこの順で組むと安定します：
  1) まず文字列を固定（リテラル中心）
  2) 揺らぎ部分だけクラス化（`[0-9]{2}` 等）
  3) ノイズが出たら境界（`^ $ \b`）を足す
  4) 置換するなら “3ステップ・プロトコル”
- 合言葉：
  - Start small, verify often（小さく始めて、頻繁に確認）
```