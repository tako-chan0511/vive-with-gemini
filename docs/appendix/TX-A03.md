# AWS実装パターン（Lambda + SQS + Dynamo/Aurora、Step Functions比較）

![TX-A03](/images/gamehub/TX-A03.jpg)

## このページ（上記図の説明）の目的

AWS（サーバーレス中心）で分散整合性を実装する際の典型パターンを整理します。
「どのAWSサービスをどう組み合わせるか」を、運用観点も含めて比較します。

---

## 1. パターンA：Lambda（Orchestrator）+ Aurora/Dynamo（Saga State）

### 概要

* API Gateway → Lambda（オーケストレーター）
* 進捗状態（Saga State）は Aurora または DynamoDB に保存
* 外部SaaS呼び出しを順に実行し、失敗時は補償を走らせる

### 長所

* 実装の自由度が高い（既存コード資産を活かしやすい）
* DBスキーマで運用情報を設計できる（監査・レポート向き）

### 短所

* オーケストレーター自前実装が肥大化しやすい
* タイムアウト（Lambda最大実行時間）に注意が必要

### いつ向くか

* “状態をDBで厳密に持ちたい”
* 既存のAurora設計や運用がある
* ステップ数が比較的少ない、または非同期化できる

---

## 2. パターンB：SQSで非同期分割（Queue Worker）

### 概要

* APIは 202 Accepted を返す
* SQS にメッセージ投入
* Worker Lambda が下流APIを実行
* 失敗はリトライされ、最終的にDLQへ

### 長所

* レート制限対策・耐障害性が高い
* 処理を小さく分割しやすい（並列化も可）

### 短所

* 結果整合前提になる（即時に揃わない）
* 取引の可視化（ステータス管理）が必須

### いつ向くか

* 下流SaaSが不安定/レート制限が厳しい
* “即時性より安定性”を優先できる

---

## 3. パターンC：Step Functions（State Machine）でSagaを表現

### 概要

* Step Functions でステップ、分岐、リトライ、補償を明示
* 各ステップは Lambda / Activity / AWS SDK 連携で実行

### 長所

* フローが可視化され、運用しやすい（状態遷移が見える）
* リトライや分岐が宣言的に書ける
* 長時間処理に強い（待ちや人手介入も組み込み可能）

### 短所

* ステートマシン設計の学習コスト
* 細かい最適化や独自要件で複雑化することがある
* 実行回数に応じたコストが気になる場合がある（要見積）

### いつ向くか

* ステップ数が多い
* 失敗分岐・補償分岐が多い
* 監査・運用で「見える化」が最重要

---

## 4. DynamoDB vs Aurora（Saga Stateの置き場所）

### DynamoDBが向く

* Key-Valueで状態を持てばよい（`transaction_id` 主キー）
* 高スループット・低運用負荷
* TTLで古い状態を自動削除したい

### Auroraが向く

* 状態を複雑に検索・集計したい（監査帳票、運用クエリ）
* 既存のリレーショナル設計がある
* 参照整合性やJOINが効くと嬉しい

結論：**運用で“どう見たいか”**が選定に直結します。

---

## 5. 必須横断要素（どのパターンでも必要）

### 5.1 相関ID（Correlation ID）

* APIリクエストごとに `transaction_id` を発行
* ログ・DB・SQSメッセージに必ず含める
* 外部SaaS呼び出しにも可能ならヘッダ等で付与

### 5.2 冪等性（Idempotency）

* Lambdaは再実行される前提
* SQSは少なくとも1回配達（重複あり得る）
* したがって冪等設計は必須

### 5.3 DLQと再処理導線

* DLQアラーム
* 再投入手順（re-drive / 手動復旧）
* Runbook整備

---

## 6. Step Functionsを採用するかの判断軸（実務の目安）

* フローが複雑で、**コードで書くと破綻しやすい** → Step Functions
* 単純フローで、既存のLambda/DB設計で十分 → 自前Orchestrator
* 下流の不安定性が高い → SQS中心の分割

---

## 7. 参考：初心者向けの“よくある失敗”と回避

* 失敗時の状態が残らず、原因追跡できない
  → 状態DB＋相関ID＋構造化ログ
* リトライで二重作成
  → Idempotency Key
* DLQが溜まっても誰も気づかない
  → 監視（アラーム）＋運用手順
* 補償が不完全で手動復旧できない
  → 補償の設計合意＋Runbook

---

## まとめ

AWSでは「SQS」「Step Functions」「状態DB（Dynamo/Aurora）」を軸に、整合性を“運用できる形”に落とし込みます。
分散トランザクションの成功は、コードだけでなく **監視・再実行・人の復旧導線**まで含めた全体設計で決まります。