import{_ as a,c as i,o as t,ae as e}from"./chunks/framework.Ai_99reE.js";const k=JSON.parse('{"title":"FastAPIバックエンドの単体テストとカバレッジ測定ガイド","description":"","frontmatter":{},"headers":[],"relativePath":"appendix/pytest.md","filePath":"appendix/pytest.md"}'),n={name:"appendix/pytest.md"};function p(l,s,h,d,o,r){return t(),i("div",null,[...s[0]||(s[0]=[e(`<h1 id="fastapiバックエンドの単体テストとカバレッジ測定ガイド" tabindex="-1">FastAPIバックエンドの単体テストとカバレッジ測定ガイド <a class="header-anchor" href="#fastapiバックエンドの単体テストとカバレッジ測定ガイド" aria-label="Permalink to &quot;FastAPIバックエンドの単体テストとカバレッジ測定ガイド&quot;">​</a></h1><p>Vue 3 + Python (FastAPI) のMonorepo構成において、バックエンドAPIの品質を担保するためのテスト自動化環境を構築する手順を解説します。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>このガイドでは、テストフレームワークとして <strong>Pytest</strong>、APIのテストクライアントとしてFastAPI付属の <strong>TestClient</strong>、テストカバレッジ測定ツールとして <strong>pytest-cov</strong> を使用します。</p></div><hr><h2 id="_1-テスト環境の構築" tabindex="-1">1. テスト環境の構築 <a class="header-anchor" href="#_1-テスト環境の構築" aria-label="Permalink to &quot;1. テスト環境の構築&quot;">​</a></h2><p>まず、テストの実行とカバレッジ測定に必要なライブラリをインストールし、設定ファイルを準備します。</p><h3 id="_1-1-必要なライブラリのインストール" tabindex="-1">1.1. 必要なライブラリのインストール <a class="header-anchor" href="#_1-1-必要なライブラリのインストール" aria-label="Permalink to &quot;1.1. 必要なライブラリのインストール&quot;">​</a></h3><p>Pythonの仮想環境が有効化されていることを確認し、以下のコマンドでライブラリをインストールします。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pytest</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pytest-cov</span></span></code></pre></div><p>インストール後、現在の環境をrequirements.txtに反映させておきましょう。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> freeze</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> requirements.txt</span></span></code></pre></div><h3 id="_1-2-フォルダ構成の準備" tabindex="-1">1.2. フォルダ構成の準備 <a class="header-anchor" href="#_1-2-フォルダ構成の準備" aria-label="Permalink to &quot;1.2. フォルダ構成の準備&quot;">​</a></h3><p>テストコードは、アプリケーションのソースコードとは別の専用フォルダに配置するのが一般的です。 プロジェクトのルートディレクトリに<code>tests</code>フォルダを作成します。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>memosphere/</span></span>
<span class="line"><span>├── api/</span></span>
<span class="line"><span>├── frontend/</span></span>
<span class="line"><span>├── tests/  &lt;-- ★ここにテストコードを配置</span></span>
<span class="line"><span>└── ...</span></span></code></pre></div><h3 id="_1-3-pytestの設定-pytest-ini" tabindex="-1">1.3. Pytestの設定 (<code>pytest.ini</code>) <a class="header-anchor" href="#_1-3-pytestの設定-pytest-ini" aria-label="Permalink to &quot;1.3. Pytestの設定 (\`pytest.ini\`)&quot;">​</a></h3><p>テストコードからapiディレクトリ内のモジュールを正しくインポートできるように、プロジェクトのルートディレクトリに<code>pytest.ini</code>を作成します。</p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[pytest]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pythonpath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = .</span></span></code></pre></div><p>この設定により、pytest実行時にプロジェクトルートがPythonの検索パスに含まれるようになり、<code>ModuleNotFoundError</code>を防ぎます。</p><h3 id="_1-4-カバレッジ測定の設定-coveragerc" tabindex="-1">1.4. カバレッジ測定の設定 (<code>.coveragerc</code>) <a class="header-anchor" href="#_1-4-カバレッジ測定の設定-coveragerc" aria-label="Permalink to &quot;1.4. カバレッジ測定の設定 (\`.coveragerc\`)&quot;">​</a></h3><p>命令網羅（C0）だけでなく、より詳細な分岐網羅（C1）も測定するために、プロジェクトのルートディレクトリに<code>.coveragerc</code>を作成します。</p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[run]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">branch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = True</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[report]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">show_missing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = True</span></span></code></pre></div><ul><li><code>branch = True</code>: 分岐網羅の測定を有効にします。</li><li><code>show_missing = True</code>: カバレッジが100%でない場合に、どの行が実行されていないかを表示します。</li></ul><hr><h2 id="_2-テストコードの実装" tabindex="-1">2. テストコードの実装 <a class="header-anchor" href="#_2-テストコードの実装" aria-label="Permalink to &quot;2. テストコードの実装&quot;">​</a></h2><p>準備が整ったら、最初のテストケースを書いてみましょう。 <code>GET /api/memos</code>エンドポイントのテストを<code>tests/test_memos_api.py</code>に記述します。</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fastapi.testclient </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TestClient</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> api.index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> app  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># メインのFastAPIアプリケーションをインポート</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># テスト用のクライアントを作成</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">client </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TestClient(app)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test_get_all_memos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;&#39;&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    GET /api/memos のテスト</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    - 正常なレスポンス（ステータスコード200）が返ってくること</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    - レスポンスのボディがリスト形式であること</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    を確認する</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;&#39;&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> client.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/api/memos&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response.status_code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 200</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    assert</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isinstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(response.json(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><hr><h2 id="_3-テストの実行と結果の解釈" tabindex="-1">3. テストの実行と結果の解釈 <a class="header-anchor" href="#_3-テストの実行と結果の解釈" aria-label="Permalink to &quot;3. テストの実行と結果の解釈&quot;">​</a></h2><h3 id="_3-1-基本的なテストの実行" tabindex="-1">3.1. 基本的なテストの実行 <a class="header-anchor" href="#_3-1-基本的なテストの実行" aria-label="Permalink to &quot;3.1. 基本的なテストの実行&quot;">​</a></h3><p>ターミナルで以下のコマンドを実行します。 pytestは<code>tests</code>フォルダ内のテストファイルを自動で見つけて実行します。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pytest</span></span></code></pre></div><p><strong>実行結果の例:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>================ test session starts ================</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>tests\\test_memos_api.py .                      [100%]</span></span>
<span class="line"><span>================= 1 passed in ...s ==================</span></span></code></pre></div><ul><li><code>.</code> はテストが成功したことを示します。</li><li><code>[100%]</code> は、発見されたテストケースの実行進捗率であり、コードカバレッジではありません。</li></ul><h3 id="_3-2-テストカバレッジの測定" tabindex="-1">3.2. テストカバレッジの測定 <a class="header-anchor" href="#_3-2-テストカバレッジの測定" aria-label="Permalink to &quot;3.2. テストカバレッジの測定&quot;">​</a></h3><p><code>--cov</code>オプションを付けて実行することで、テストカバレッジを測定できます。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pytest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --cov=api</span></span></code></pre></div><p><strong>実行結果の例:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>================== tests coverage ===================</span></span>
<span class="line"><span>Name                    Stmts   Miss Branch BrPart  Cover   Missing</span></span>
<span class="line"><span>-------------------------------------------------------------------</span></span>
<span class="line"><span>api\\db.py                  14      0      0      0   100%</span></span>
<span class="line"><span>api\\routers\\memos.py       24     11      2      2    46%   20-35</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>-------------------------------------------------------------------</span></span>
<span class="line"><span>TOTAL                      59     11      2      2    79%</span></span></code></pre></div><h3 id="_3-3-カバレッジレポートの見方" tabindex="-1">3.3. カバレッジレポートの見方 <a class="header-anchor" href="#_3-3-カバレッジレポートの見方" aria-label="Permalink to &quot;3.3. カバレッジレポートの見方&quot;">​</a></h3><table tabindex="0"><thead><tr><th>列</th><th>意味</th></tr></thead><tbody><tr><td>Stmts</td><td>実行可能なコードの行数（C0: 命令網羅の母数）</td></tr><tr><td>Miss</td><td>テストで実行されなかったコードの行数</td></tr><tr><td>Branch</td><td>if文などの分岐の総数（C1: 分岐網羅の母数）</td></tr><tr><td>BrPart</td><td>部分的にしか実行されなかった分岐の数</td></tr><tr><td>Cover</td><td>総合的なカバレッジ率（命令網羅＋分岐網羅）</td></tr><tr><td>Missing</td><td>実行されなかった行番号や分岐の詳細</td></tr></tbody></table><p>このレポートから、 「<code>api/routers/memos.py</code>のPOST処理やDELETE処理（11行が未実行）のテストを書けば、カバレッジが向上する」 という、次のアクションが明確になります。</p><hr><h2 id="tips-トラブルシューティング" tabindex="-1">Tips &amp; トラブルシューティング <a class="header-anchor" href="#tips-トラブルシューティング" aria-label="Permalink to &quot;Tips &amp; トラブルシューティング&quot;">​</a></h2><ul><li><p><strong><code>ModuleNotFoundError: No module named &#39;api&#39;</code></strong>:</p><ul><li><code>tests</code>フォルダがプロジェクトルートにないか、<code>pytest.ini</code>の設定が間違っています。フォルダ構造と設定ファイルを見直してください。</li></ul></li><li><p><strong>SQLAlchemyのWarning</strong>:</p><ul><li><code>api/db.py</code>で<code>declarative_base</code>を<code>sqlalchemy.orm</code>からインポートすることで、将来のバージョンアップに対応できます。<div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># from sqlalchemy.ext.declarative import declarative_base # 古い</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sqlalchemy.orm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> declarative_base </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 新しい</span></span></code></pre></div></li></ul></li></ul>`,45)])])}const g=a(n,[["render",p]]);export{k as __pageData,g as default};
